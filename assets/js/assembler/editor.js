var mipsInstructions,processor,keyStrokes=[],processingKeyStrokes=!1,userBadBytes=[];function shouldProcess(e){return e>47&&e<58||32==e||13==e||e>36&&e<41||8==e||9==e||46==e||e>64&&e<91||e>95&&e<112||e>185&&e<193||e>218&&e<223}function combineSpans(e,t){var n=t[0];if(""==n.textContent&&n!=e){var o=n.previousSibling,r=n.nextSibling;if(o&&r&&"DIV"!=o.nodeName&&"DIV"!=r.nodeName)if(","!=o.textContent&&","!=r.textContent){var a=o.textContent.length;o.textContent+=r.textContent,n.parentNode.removeChild(r),n.parentNode.removeChild(n),setCursor(o,a)}else""==n.textContent&&n.parentNode.removeChild(n)}}function processKeyDown(e){if(shouldProcess(e.keyCode)&&!e.ctrlKey&&!e.altKey&&((e.keyCode<36||e.keyCode>41)&&e.preventDefault(),keyStrokes.push(e),!processingKeyStrokes)){for(processingKeyStrokes=!0;keyStrokes.length;)try{var t=keyStrokes.shift();switch(t.key){case"Tab":insertTab(4);break;case"Delete":try{document.execCommand("forwardDelete",!1,null)}catch(e){break}break;case"Backspace":document.execCommand("delete",!1,null);break;case"Enter":removeEmptySpans(document.getElementById("assembly")),fixSpan(o=findPosition()," ",!0),o.className="",document.execCommand("insertParagraph",!1,null);var n=(o=findPosition())[0].parentNode.previousSibling;n.textContent.startsWith(" ")&&insertTab(n.textContent.search(/\S|$/));break;case"ArrowLeft":case"ArrowUp":case"ArrowDown":case"ArrowRight":var o;3==(o=findPosition())[0].nodeType&&fixSpan(o," ",!1);break;default:document.execCommand("insertText",!1,t.key)}processKeyPressed(e)}catch(e){console.log(e)}processingKeyStrokes=!1}}function insertTab(e){var t=findPosition();if("whitespace"==t[0].className)t[0].textContent+=" ".repeat(e);else{var n=document.createElement("span");n.className="whitespace",n.textContent=" ".repeat(e),t[0].parentNode.insertBefore(n,t[0])}var o=document.createElement("span");o.textContent="",t[0].parentNode.insertBefore(o,t[0]),setCursor(o,0)}function processKeyPressed(e){var t=findPosition(),n=document.getElementById("assembly");switch(e.keyCode){case 32:fixSpan(t," ",!1);break;case 57:case 48:if(!e.shiftKey)break;case 188:fixSpan(t,e.key,!1);break;case 13:t[0].className="",addLineNumber(n,!1);break;case 8:combineSpans(n,t);case 46:removeLineNumber(n)}syntaxHighlight(n),updatePage()}function findPosition(){var e=window.getSelection(),t=e.anchorNode.parentNode;return"DIV"==t.tagName&&(t=e.anchorNode),[t,e.focusOffset]}function fixSpan(e,t,n){var o=e[0].textContent.split(t);if(1!=o.length){if(""==o[0]&&e[0].previousSibling&&e[0].previousSibling.textContent.endsWith(t))return e[0].previousSibling.textContent+=t,void(e[0].textContent=e[0].textContent.slice(1));if(""==o[1]&&e[0].nextSibling&&e[0].nextSibling.textContent.startsWith(t))return e[0].nextSibling.textContent=t+e[0].nextSibling.textContent,void(e[0].textContent=e[0].textContent.slice(0,e[0].textContent.length-1));var r=document.createElement("span"),a=document.createElement("span"),s=null,l=null,i=0;""==o[0]||" "==o[0]?(r.innerHTML=t,a.textContent=e[0].textContent.replace(t,""),l=a,n&&(i=a.textContent.length)):""==o[1]||" "==o[1]?(r.textContent=e[0].textContent.replace(t,""),a.innerHTML=t):(r.textContent=o[0],a.textContent=o[1],(s=document.createElement("span")).textContent=t,l=a),","==t&&(document.createElement("span").textContent=","),e[0].parentNode.insertBefore(r,e[0]),s&&e[0].parentNode.insertBefore(s,e[0]),e[0].parentNode.insertBefore(a,e[0]),e[0].parentNode.removeChild(e[0]),l&&setCursor(l,i)}else if(3==e[0].nodeType){var d=document.createElement("span");d.textContent=o[0],e[0].replaceWith(d),setCursor(d,d.textContent.length)}}function setCursor(e,t){var n=document.createRange(),o=document.getSelection(),r=e;0!=e.childNodes.length&&(r=e.childNodes[0]),n.setStart(r,t),n.collapse(!0),o.removeAllRanges(),o.addRange(n)}function addLineNumber(e,t){var n=document.getElementById("line-numbers");for(null!=e.children&&0!=e.children.length||(t=!0);n.children.length<e.children.length||t;){var o=document.createElement("span");o.className="line-number",n.appendChild(o),t=!1}}function removeLineNumber(e){for(var t=document.getElementById("line-numbers");e.children.length<t.children.length;){if(1==t.children.length)return;t.removeChild(t.childNodes[t.childElementCount-1])}}function handleCopyPaste(e){let t=document.getElementById("assembly");"insertFromPaste"===e.inputType&&(fixUpPlainText(t),removeEmptySpans(t),syntaxHighlight(t),updatePage())}function updatePage(){var e=document.getElementById("assembly"),t=document.getElementById("endian").value;processor.endian=t,processor.processAssembly(e),processor.generateBytes(),handleByteString(processor),handleErrors(processor),handleBytes(processor)}function removeTrailingSpaces(e){var t=[];e.querySelectorAll("div").forEach(e=>{""==e.lastChild.innerHTML.trim()&&"SPAN"==e.lastChild.nodeName&&t.push(e.lastChild)}),t.forEach(t=>{var n=t.parentElement;n.removeChild(t),0==n.childCount&&(e.remove(n),removeLineNumber(e))})}function removeEmptySpans(e){var t=[];e.querySelectorAll("div").forEach(e=>{e.querySelectorAll("span").forEach(e=>{""==e.textContent&&"whitespace"!=e.className&&t.push(e)})}),t.forEach(e=>{e.parentElement.removeChild(e)})}function handleByteString(e){var t=document.getElementById("byte-string"),n=e.byteString;0==n.length?t.textContent="No bytes found. Write some assembly first.":t.textContent=n}function handleBytes(e){var t=document.getElementById("bytes");clearSpan(t),e.byteArrays.forEach(e=>{var n=document.createElement("div");n.className="byte-line",(r=document.createElement("span")).textContent=" ",n.appendChild(r);for(var o=0;o<e.length;o++){var r,a=document.createElement("span");a.textContent=e[o],-1!=userBadBytes.indexOf(e[o])&&(a.className="bad-byte"),n.appendChild(a),(r=document.createElement("span")).textContent=" ",n.appendChild(r)}t.appendChild(n)})}function handleErrors(e){var t=e.errorLines,n=document.getElementById("errors"),o=document.getElementById("error-count");clearSpan(n),n.textContent="No errors detected.",o.className="",t.forEach(e=>{addErrorMessage(e.element,e.error),e.element.className="invalid-instruction"})}function copyBytesToClipboard(){var e=document.getElementById("byte-string");if(e.textContent.startsWith("No bytes"))tooltip.textContent="No bytes to copy. Write some assembly first.";else{document.getElementById("tooltip");navigator.clipboard.writeText(e.textContent).then(function(){tooltip.textContent="Copied "+e.textContent.length/4+" bytes."},function(e){tooltip.textContent=e})}}function clearTooltip(e){document.getElementById("tooltip");tooltip.textContent="Copy bytes to clipboard"}function addErrorMessage(e,t){var n=document.createElement("div"),o=Array.prototype.indexOf.call(e.parentElement.children,e)+1,r=document.getElementById("errors"),a=document.getElementById("error-count");a.className="errors-present",0==r.childElementCount&&(r.textContent=""),n.textContent="Line "+o+": "+t,r.appendChild(n),a.textContent=r.childElementCount}function changeArchitecture(e){var t=e.target.value,n=document.getElementById("assembly");document.getElementById("endian");if(""==t)return n.textContent="Select architecture above to get started.",void(n.contentEditable=!1);mipsInstructions=new MipsInstructions(t),n.innerHTML=loadMessage(),fixUpPlainText(n),removeEmptySpans(n),syntaxHighlight(n),updatePage(),n.contentEditable=!0,setCursor(n.lastChild.lastChild,n.lastChild.lastChild.textContent.length)}function clearSpan(e){if(null!=e)for(;e.firstChild;)e.removeChild(e.firstChild)}function hoverUpdateBadBytes(e){0!=e.buttons&&updateBadBytes(e)}function updateBadBytes(e){-1==e.target.className.split(" ").indexOf("down")?e.target.className+=" down":e.target.className=" ";var t=e.target.value.slice(2),n=userBadBytes.indexOf(t);-1!=n?userBadBytes.splice(n,1):userBadBytes.push(t),updatePage()}function handleCollapse(e){var t=e.target;if(t.id.endsWith("collapse"))t.classList.toggle("active");else{if("copy-bytes"==e.target.id)return void copyBytesToClipboard();(t=t.parentElement).classList.toggle("active")}var n=t.nextElementSibling;n.style.maxHeight?(n.style.maxHeight=null,n.style.overflow="hidden"):(n.style.maxHeight=n.scrollHeight+"px",n.style.overflow="initial")}function fixUpPlainText(e){var t=e.innerText.split("\n");e.innerText="",t.forEach(t=>{var n=document.createElement("div");if(""!=t&&" "!=t)t.split(" ").forEach(e=>{if(""==e&&null!=n.lastChild&&" "==n.lastChild.textContent[0]&&"    "!=n.lastChild.textContent)n.lastChild.textContent+=" ";else{var t=document.createElement("span"),o=document.createElement("span"),r=null;e.endsWith(",")&&(e=e.slice(0,e.length-1),(r=document.createElement("span")).textContent=","),t.textContent=e,o.textContent=" ",n.appendChild(t),r&&n.appendChild(r),n.appendChild(o)}});else{var o=document.createElement("br");n.appendChild(o)}e.appendChild(n),addLineNumber(e,!1)}),removeTrailingSpaces(e)}function onReady(e){"complete"===document.readState||"interactive"===document.readyState?setTimeout(e,1):document.addEventListener("DOMContentLoaded",e)}onReady(function(){var e=document.getElementById("assembly"),t=(document.getElementById("errors"),document.getElementById("error-count"),document.getElementById("endian")),n=document.getElementById("arch"),o=document.getElementById("bad-bytes"),r=document.getElementById("bb-collapse"),a=document.getElementById("bs-collapse"),s=document.getElementById("err-collapse");e.value="",n.value="",addLineNumber(e,!0),e.addEventListener("keydown",processKeyDown),e.addEventListener("input",handleCopyPaste),t.addEventListener("change",updatePage),n.addEventListener("change",changeArchitecture),r.addEventListener("click",handleCollapse),a.addEventListener("click",handleCollapse),s.addEventListener("click",handleCollapse);var l=getParser();processor=new Processor(l);for(var i=0;i<=255;i++){var d=document.createElement("input");d.type="button";var c=i.toString(16);c.length<2&&(c="0"+c),d.value="0x"+c,d.addEventListener("mousedown",updateBadBytes),d.addEventListener("mouseenter",hoverUpdateBadBytes),o.appendChild(d)}});